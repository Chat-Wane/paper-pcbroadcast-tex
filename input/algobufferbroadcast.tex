
\SetKwProg{Function}{function}{}{}
\SetKwProg{Upon}{upon}{}{}
\SetKwProg{Initially}{INITIALLY:}{}{}
\SetKwProg{Dissemination}{DISSEMINATION:}{}{}
\SetKwProg{Safety}{SAFETY:}{}{}

\small

\DontPrintSemicolon
\LinesNumbered

\Initially {} {
  $Q$ \tcp*{$p$'s neighborhood, FIFO channels}
  $B \leftarrow \varnothing$ \tcp*{Buffers of messages}
  \BlankLine
  $counter \leftarrow 0$ \tcp*{Used as identifier}  
}

\BlankLine

\Safety {} {
  \Upon{\textsc{open}($q$)} {
    \If{$|Q|>1$} {
      $counter \leftarrow counter+1$ \;
      $Q \leftarrow Q \setminus q$ \;
      $B[counter] \leftarrow \varnothing$ \;
      $\textsc{sendLocked}(p,\, q,\, counter)$ \label{line:sendlocked} \; 
    }
  }
  
  \BlankLine
  
  \Upon{\textsc{receiveLocked}($from,\, to,\, id$) \tcp*[f]{$to=p$}} {
    $\textsc{sendAck}(from,\, to,\, id)$ \label{line:sendack} \;
  }
  
  \BlankLine

  \Upon{\textsc{receiveAck}($from,\, to,\, id$) \tcp*[f]{$from=p$}} {
    \If {$id \in B$} {
      \lForEach {$m \in B[id]$} {$\textsc{sendTo}(to,\, m)$
        \label{line:emptybuffer}}
      $B \leftarrow B \setminus id$ \;
      $Q \leftarrow Q \cup to$ \;
    }
  }

  \BlankLine

  % \Upon{\textsc{close}($q$)} {
  %   $B \leftarrow B \setminus q$ \;
  % }
}

\BlankLine

\Dissemination {} {

  \Function{\textsc{FBC-broadcast}$^+$($m$) \tcp*[f]{$b_p(m)$}} {    
    \lForEach {$i \in B$} {$B[i] \leftarrow B[i] \cup m$
      \label{line:bufferbroadcast} \tcp*[f]{Buffers}}
    $\textsc{R-broadcast}(m)$ \;
  }
  
  \BlankLine
  
  \Upon{\textsc{R-deliver}($m$)} {
    \lForEach {$i \in B$} {$B[i] \leftarrow B[i] \cup m$
      \label{line:bufferforward} \tcp*[f]{Buffers}}
    $\textsc{FBC-deliver}^+(m)$ \tcp*{$d_p(m)$}
  }

}


%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../paper"
%%% End:
