
\SetKwProg{Function}{function}{}{}
\SetKwProg{Upon}{upon}{}{}
\SetKwProg{Initially}{INITIALLY:}{}{}
\SetKwProg{Dissemination}{DISSEMINATION:}{}{}
\SetKwProg{Safety}{SAFETY:}{}{}

\small

\DontPrintSemicolon
\LinesNumbered

\Initially {} {
  $Q$ \tcp*{$p$'s neighborhood, FIFO channels}
  $B \leftarrow \varnothing$ \tcp*{Buffers of messages}
}

\BlankLine

\Safety {} {
  \Upon{\textsc{open}($q$)} {
    \If{$|Q|>1$} {
      $Q \leftarrow Q \setminus q$ \;
      $B[q] \leftarrow \varnothing$ \;
      $\textsc{sendLocked}(p,\, q)$ \label{line:sendlocked} \; 
    }
  }
  
  \BlankLine
  
  \Upon{\textsc{receiveLocked}($from, \, to$) \tcp*[f]{$to=p$}} {
    $\textsc{sendAck}(from,\, to)$ \label{line:sendack} \;
  }
  
  \BlankLine

  \Upon{\textsc{receiveAck}($from,\, to$) \tcp*[f]{$from=p$}} {
    \If {$to \in B$} {
      \lForEach {$m \in B[to]$} {$\textsc{sendTo}(to,\, m)$
        \label{line:emptybuffer}}
      $B \leftarrow B \setminus to$ \;
      $Q \leftarrow Q \cup to$ \;
    }
  }

  \BlankLine

  \Upon{\textsc{close}($q$)} {
    $B \leftarrow B \setminus q$ \;
  }

}

\BlankLine

\Dissemination {} {

  \Function{\textsc{FBC-broadcast}$^+$($m$) \tcp*[f]{$b_p(m)$}} {    
    \lForEach {$q \in B$} {$B[q] \leftarrow B[q] \cup m$
      \label{line:bufferbroadcast} \tcp*[f]{Buffers}}
    $\textsc{R-broadcast}(m)$ \;
  }
  
  \BlankLine
  
  \Upon{\textsc{R-deliver}($m$)} {
    \lForEach {$q \in B$} {$B[q] \leftarrow B[q] \cup m$
      \label{line:bufferforward} \tcp*[f]{Buffers}}
    $\textsc{FBC-deliver}^+(m)$ \tcp*{$d_p(m)$}
  }

}


%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../paper"
%%% End:
