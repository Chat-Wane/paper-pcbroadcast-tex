
\SetKwProg{Function}{function}{}{}
\SetKwProg{Upon}{upon}{}{}
\SetKwProg{Initially}{INITIALLY:}{}{}
\SetKwProg{Dissemination}{DISSEMINATION:}{}{}
\SetKwProg{Safety}{SAFETY:}{}{}

\small

\DontPrintSemicolon
\LinesNumbered

\Initially {} {
  $Q$ \tcp*{$p$'s neighborhood, FIFO links}
  $B \leftarrow \varnothing$ \tcp*{link $\rightarrow$ buffered messages}
  \BlankLine
  $counter \leftarrow 0$ \tcp*{Message identifier}
}

\BlankLine

\Safety {} {
  \Upon{\textup{open}($q$)} {
    \If{$|Q|>1$} {
      $counter \leftarrow counter+1$ \;
      $Q \leftarrow Q \setminus q$ \;
      $B[q] \leftarrow \varnothing$ \;
      $\textup{sendLocked}(p,\, q,\, counter)$ \label{line:sendlocked} \; 
    }
  }
  
  \BlankLine
  
  \Upon{\textup{receiveLocked}($from,\, to,\, id$) \tcp*[f]{$to=p$}} {
    $\textup{sendAck}(from,\, to,\, id)$ \label{line:sendack} \;
  }
  
  \BlankLine
  
  \Upon{\textup{receiveAck}($from,\, to,\, id$) \tcp*[f]{$from=p$}} {
    \If {$to \in B$} {
      \lForEach {$m \in B[to]$} {$\textup{sendTo}(to,\, m)$
        \label{line:emptybuffer}}
      $B \leftarrow B \setminus to$ \;
      $Q \leftarrow Q \cup to$ \;
    }
  }
  
  \BlankLine
  
  \Upon{\textup{close}($q$)} {
    $B \leftarrow B \setminus q$ \;
  }
}

\BlankLine

\Dissemination {} {

  \Function{\textup{FBC-broadcast}$^+$($m$) \tcp*[f]{$b_p(m)$}} {    
    \lForEach {$q \in B$} {$B[q] \leftarrow B[q] \cup m$
      \label{line:bufferbroadcast} \tcp*[f]{Buffers}}
    $\textup{R-broadcast}(m)$ \label{line:rbroadcast}\;
  }
  
  \BlankLine
  
  \Upon{\textup{R-deliver}($m$) \label{line:rdeliver}} {
    \lForEach {$q \in B$} {$B[q] \leftarrow B[q] \cup m$
      \label{line:bufferforward} \tcp*[f]{Buffers}}
    $\textup{FBC-deliver}^+(m)$ \tcp*{$d_p(m)$}
  }

}


%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../paper"
%%% End:
